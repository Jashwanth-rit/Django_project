{% extends 'base.html' %}

{% block content %}
    <!-- Header -->
    <header class="bg-dark py-5">
        <div class="container px-4 px-lg-5 my-5">
            <div class="text-center text-white">
                <h1 class="display-4 fw-bolder">Shopping Cart</h1>
                <p class="lead fw-normal text-white-50 mb-0">View your cart..</p>
            </div>
        </div>
    </header>

    <!-- Shopping Cart Section -->
    <section class="py-5">
        <div class="container px-4 px-lg-5">
            <div class="row">
                {% if cart_items %}
                    {% for item in cart_items %}
                    <div class="col-12 mb-4">
                        <div class="card d-flex flex-row align-items-center p-3">
                            <!-- Product image-->
                            <img class="img-fluid" src="{{ item.image.url }}" alt="{{ item.name }}" style="width: 150px; height: auto; margin-right: 20px;">
                            <!-- Product details-->
                            <div class="flex-grow-1">
                                <h5 class="fw-bolder">{{ item.name }}</h5>
                                <h5 class="fw-bolder">{{ item.id }}</h5>
                                <p class="text-muted mb-2">{{ item.category }}</p>
                                {% if item.is_sale %}
                                    <span class="text-muted text-decoration-line-through">${{ item.price }}</span>
                                    <span class="text-danger">${{ item.sale_price }}</span>
                                {% else %}
                                    <span>${{ item.price }}</span>
                                {% endif %}
                                <!-- Quantity selection -->
                                <select class="form-select text-center me-3" id="quantitySelect{{ item.id }}" style="max-width: 5rem">
                                    {% for key, value in quantity.items %}
                                        {% if key == item.id|stringformat:"s" %}
                                            <option selected>{{ value }}</option>  <!-- Pre-select the quantity -->
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <!-- Add the other range options -->
                                    {% for i in quantity_range %}
                                        <option value="{{ i }}">{{ i }}</option>
                                    {% endfor %}
                                </select>
                                
                                <p class="card-text mt-2">{{ item.description }}</p>
                            </div>
                            <!-- Remove and Buy buttons -->
                            <div class="d-flex flex-column">
                                <a href="{% url 'cart_delete' item.id %}" class="btn btn-danger btn-sm mb-2">Remove</a>
                                <button class="btn btn-outline-dark flex-shrink-0" type="button" data-index="{{ item.id }}" id="update-cart{{ item.id }}">
                                    Update
                                </button>
                                <a href="#" class="btn btn-primary btn-sm">Buy</a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="col-12">
                        <p class="text-center">Your cart is empty.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </section>

    <script>
        $(document).on("click", '[id^=update-cart]', function(e) {
            e.preventDefault();
    
            var productId = $(this).data('index');
            var quantity = $('#quantitySelect' + productId).val();  // Get selected quantity based on unique id
    
            $.ajax({
                type: 'POST',
                url: '{% url "cart_update" %}',
                data: {
                    product_id: productId,
                    quantity: quantity,  // Pass the quantity to the backend
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    action: 'post'
                },
                success: function(json) {
                    location.reload();
                },
                error: function(xhr, errmsg, err) {
                    console.error("Error occurred:", errmsg, err);
                }
            });
        });
    </script>
{% endblock %}
